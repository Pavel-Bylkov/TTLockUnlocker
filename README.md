# TTLockUnlocker — автоматизация управления замками TTLock через облако

> ⚠️ Важно: используйте только python-telegram-bot (строка python-telegram-bot==20.7 в requirements.txt). Не добавляйте telegram==0.0.1 — это приведёт к ошибкам импорта!

## Описание

Комплекс для автоматического управления замками TTLock через облачный API с уведомлениями в Telegram. Включает:
- `auto_unlocker.py` — автоматическое открытие замка по расписанию (по умолчанию 9:00 утра по Новосибирску)
- `telegram_bot.py` — Telegram-бот для управления рассылкой уведомлений и смены получателя через Docker
- **config.json** — хранит настройки расписания, часового пояса, перерывов, включено ли расписание
- Гибкая настройка через `.env` и `config.json`
- Логирование с ротацией, безопасность, работа в Docker

## Архитектура

- **auto_unlocker**: основной сервис, открывает замок по расписанию, отправляет уведомления в Telegram, пишет логи
- **telegram_bot**: отдельный контейнер, позволяет менять настройки через Telegram (после реализации соответствующих команд)
- **config.json**: общий файл с настройками (часовой пояс, расписание, перерывы, включено/выключено), пробрасывается в оба контейнера через bind-mount
- **.env**: должен лежать в папке `./env/.env` и пробрасывается в контейнеры через bind-mount
- **logs**: логи обоих сервисов доступны на хосте через bind-mount

# Проект для автоматизации управления замками TTLock через Telegram-бота

## Установка и запуск

### 1. Обновление системы
- После подключения обновите пакеты:
  ```bash
  sudo apt update && sudo apt upgrade -y
  ```

### 2. Установка необходимых пакетов
- Установите Docker и Docker Compose:
  ```bash
  sudo apt install -y docker.io docker-compose
  ```

### 3. Добавление пользователя в группу Docker (опционально)
- Чтобы запускать Docker без `sudo`, добавьте своего пользователя в группу Docker:
  ```bash
  sudo usermod -aG docker $USER
  ```
- Выйдите и снова войдите в систему, чтобы изменения вступили в силу.

### 4. Клонирование проекта с GitHub
- Установите Git, если он еще не установлен:
  ```bash
  sudo apt install -y git
  ```
- Клонируйте репозиторий:
  ```bash
  git clone https://github.com/Pavel-Bylkov/TTLockUnlocker.git
  cd TTLockUnlocker
  ```

### 5. Настройка проекта
- Отредактируйте существующий файл `config.json` в соответствии с вашими требованиями.
- Скопируйте `.env` из примера ниже и положите его в папку `env/.env` рядом с `docker-compose.yml`
```bash
   mkdir -p env
   chown -R 1000:1000 env
   chmod -R 755 env
   nano env/.env
   ```
- **Создайте папку для логов и выдайте права (обязательно!):**
   ```bash
   mkdir -p logs
   chown -R 1000:1000 logs
   chmod -R 755 logs
   ```
   (UID 1000 — стандартный для большинства Linux, если у вас другой UID для пользователя контейнера, используйте его)


### 8. Запуск проекта
**Для первого получения chat_id** (если вы не знаете свой chat_id):
   - Запустите `telegram_bot.py` отдельно (локально, не в контейнере)
   - Убедитесь, что переменная `ENV_PATH` в .env не задана или закомментирована (или отсутствует)
   - Бот автоматически обновит файл `./env/.env` в текущей папке
   - После успешной смены получателя chat_id появится в .env

#### Запуск проекта через make

Для первого запуска (сборка и запуск контейнеров):

```
make start
```
или
```
./start.sh
```

Для повторного запуска (если контейнеры уже собраны):

```
make up
```
или
```
./start.sh
```

Для остановки контейнеров:

```
make down
``` 

### 9. Проверка работы
- Убедитесь, что все контейнеры запущены и работают корректно:
  ```bash
  docker ps
  ```

## Команды Makefile

- `make build` - сборка контейнеров.
- `make up` - запуск контейнеров в фоновом режиме.
- `make down` - остановка контейнеров.
- `make test` - запуск тестов с использованием pytest.
- `make start` - автоматическая установка прав доступа, сборка и запуск контейнеров.
- `make fixperms` - установка прав доступа к файлам и папкам.

## Проблемы и решения

- Если бот не может найти контейнер `auto_unlocker`, убедитесь, что он запущен с помощью команды `docker ps`.
- Для получения статуса используйте команду `/status` в Telegram-боте.
Проверьте логи:
   ```bash
   tail -n 30 logs/auto_unlocker.log
   tail -n 30 logs/telegram_bot.log
   ```


## Настройка переменных окружения (.env)

```
# TTLock API
TTLOCK_CLIENT_ID=ваш_client_id_из_TTLock_Open_Platform
TTLOCK_CLIENT_SECRET=ваш_client_secret_из_TTLock_Open_Platform
TTLOCK_USERNAME=ваш_email_от_TTLock
TTLOCK_PASSWORD=ваш_пароль_от_TTLock
# TTLOCK_LOCK_ID=опционально_если_нужно_жёстко_задать

# Telegram
TELEGRAM_BOT_TOKEN=ваш_telegram_bot_token
TELEGRAM_CHAT_ID=ваш_telegram_chat_id
TELEGRAM_CODEWORD=secretword
AUTO_UNLOCKER_CONTAINER=auto_unlocker_1
# ENV_PATH=/app/.env   # Не указывайте для первого запуска бота локально!
```

- **Важно:** username и password — только от аккаунта владельца замка!
- Не публикуйте .env и логи с чувствительными данными.

## Настройка расписания и параметров (config.json)

Файл `config.json` должен лежать рядом с `docker-compose.yml` и пробрасывается в оба контейнера через bind-mount:
```
./config.json:/app/config.json
```

**Пример config.json:**
```
{
  "timezone": "Asia/Novosibirsk",
  "schedule_enabled": true,
  "open_times": {
    "monday": "09:00",
    "tuesday": "09:00",
    "wednesday": "09:00",
    "thursday": "09:00",
    "friday": "09:00",
    "saturday": null,
    "sunday": null
  },
  "breaks": {
    "monday": ["13:00-14:00"],
    "tuesday": [],
    "wednesday": [],
    "thursday": [],
    "friday": [],
    "saturday": [],
    "sunday": []
  }
}
```
- Можно редактировать вручную или (после реализации) через Telegram-бота.
- Если `schedule_enabled` = false — автоматическое открытие по расписанию отключено.
- Можно задать разное время открытия и перерывы для каждого дня недели.
- `timezone` — любой поддерживаемый pytz (например, Europe/Moscow, Asia/Novosibirsk).

## Возможности auto_unlocker
- Открытие замка по расписанию (гибко настраивается через config.json)
- Если lock_id не задан — определяется автоматически при старте
- Все события логируются (ротация 14 дней)
- Важные события отправляются в Telegram
- Все параметры берутся из .env и config.json

## Telegram-бот
- Получение важных событий от auto_unlocker в Telegram
- Управление расписанием, временем, перерывами, включением/выключением через команды Telegram
- Смена получателя уведомлений (chat_id) через команду `/setchat` и кодовое слово
- Перезапуск auto_unlocker при смене chat_id (если контейнер доступен)
- Логирование событий бота (`logs/telegram_bot.log`)

### Смена получателя уведомлений
1. В Telegram напишите боту команду `/setchat`
2. Введите кодовое слово (нужно указать в .env)
3. Подтвердите смену (ответьте "да")
4. Бот обновит .env и (если возможно) перезапустит auto_unlocker
5. Если контейнер не найден (например, при первом запуске локально), просто перезапустите auto_unlocker вручную после обновления .env

## Docker Compose

В проекте используется `docker-compose.yml`, который поднимает два контейнера:
- `auto_unlocker` — основной сервис
- `telegram_bot` — бот для управления рассылкой и смены chat_id

Оба контейнера используют bind-mount для логов и настроек:
- `./logs:/app/logs` — логи обоих сервисов на хосте
- `./env/.env:/app/.env` — .env для обоих сервисов
- `./config.json:/app/config.json` — настройки расписания и параметров

## Безопасность
- Не публикуйте .env, config.json и логи с чувствительными данными
- Используйте сложное кодовое слово
- Для production ограничьте доступ к volume и Telegram-боту

## Справка: unlocker.py (ручные эксперименты)

Файл `unlocker.py` предназначен только для ручных тестов и отладки API TTLock. Не используется в автоматизации и Docker.
- Позволяет вручную получать токен, список замков, открывать/закрывать замок, получать статус
- Все параметры также берёт из .env
- Для автоматизации используйте только `auto_unlocker.py`

---

## Запуск тестов

Для запуска всех юнит-тестов используйте:

```
make test
```
или
```
./start.sh test
```

Для получения процента покрытия (coverage):

```
pip install pytest-cov
pytest --cov=.
```



## Возможное развитие: поддержка нескольких админов и владельца

В перспективе архитектура бота может быть расширена для поддержки:
- **Списка админов** (admin_chat_ids) — несколько пользователей с правами управления.
- **Владельца** (owner_chat_id) — главный администратор, который может передавать права и управлять списком админов.

### Предлагаемая структура хранения (config.json):
```json
{
  "owner_chat_id": "123456789",
  "admin_chat_ids": ["123456789", "987654321"]
}
```
- `owner_chat_id` — всегда один, это главный владелец.
- `admin_chat_ids` — список chat_id, которые имеют права администратора (включая владельца).

### Алгоритм передачи прав владельца
1. Только текущий владелец может инициировать передачу прав.
2. Новый владелец должен сначала начать диалог с ботом (чтобы бот получил его chat_id).
3. Бот уведомляет владельца о запросе на добавление нового админа/передачу прав.
4. После подтверждения владельцем новый chat_id становится owner_chat_id, добавляется в admin_chat_ids.
5. Старый владелец остаётся админом (или может быть удалён).

### Добавление/удаление админов
- Только владелец может добавлять/удалять админов.
- Для этого потребуется реализовать команды `/addadmin`, `/removeadmin` с подтверждением.

### Необходимые доработки для реализации
- Хранить owner_chat_id и admin_chat_ids в config.json.
- Проверку доступа реализовать через функции is_admin и is_owner.
- Реализовать команды для управления списком админов и передачи прав.
- Добавить механизм согласования (бот уведомляет владельца о запросе на добавление нового админа).

**Текущая реализация поддерживает только одного владельца (chat_id), но архитектура легко расширяется до описанной выше.**

