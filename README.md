# TTLockUnlocker — автоматизация управления замками TTLock через облако

## Описание

Комплекс для автоматического управления замками TTLock через облачный API с уведомлениями в Telegram. Включает:
- `auto_unlocker.py` — автоматическое открытие замка по расписанию (по умолчанию 9:00 утра по Новосибирску)
- `telegram_bot.py` — Telegram-бот для управления рассылкой уведомлений и смены получателя через Docker
- Гибкая настройка через `.env`
- Логирование с ротацией, безопасность, работа в Docker

## Архитектура

- **auto_unlocker**: основной сервис, открывает замок по расписанию, отправляет уведомления в Telegram, пишет логи
- **telegram_bot**: отдельный контейнер, позволяет сменить chat_id для уведомлений через команду `/setchat` в Telegram, перезапускает auto_unlocker при смене
- **Общий volume**: для логов (оба контейнера используют одни и те же логи)
- **.env**: теперь должен лежать в папке `./env/.env` и пробрасывается в контейнеры через bind-mount

## Быстрый старт

1. Скопируйте `.env` из примера ниже и положите его в папку `env/.env` рядом с `docker-compose.yml`
2. **Для первого получения chat_id** (если вы не знаете свой chat_id):
   - Запустите `telegram_bot.py` отдельно (локально, не в контейнере)
   - Убедитесь, что переменная `ENV_PATH` в .env не задана или закомментирована (или отсутствует)
   - Бот автоматически обновит файл `./env/.env` в текущей папке
   - После успешной смены получателя chat_id появится в .env
3. После этого можно запускать контейнеры через Docker Compose:
   ```bash
   docker-compose up --build -d
   ```
4. Проверьте логи:
   ```bash
   docker logs -f auto_unlocker_1
   docker logs -f telegram_bot_1
   ```

## Настройка переменных окружения (.env)

```
# TTLock API
TTLOCK_CLIENT_ID=ваш_client_id_из_TTLock_Open_Platform
TTLOCK_CLIENT_SECRET=ваш_client_secret_из_TTLock_Open_Platform
TTLOCK_USERNAME=ваш_email_от_TTLock
TTLOCK_PASSWORD=ваш_пароль_от_TTLock
# TTLOCK_LOCK_ID=опционально_если_нужно_жёстко_задать

# Telegram
TELEGRAM_BOT_TOKEN=ваш_telegram_bot_token
TELEGRAM_CHAT_ID=ваш_telegram_chat_id
TELEGRAM_CODEWORD=secretword
AUTO_UNLOCKER_CONTAINER=auto_unlocker_1
# ENV_PATH=/app/.env   # Не указывайте для первого запуска бота локально!
```

- **Важно:** username и password — только от аккаунта владельца замка!
- Не публикуйте .env и логи с чувствительными данными.

## Возможности auto_unlocker
- Открытие замка по расписанию (09:00 Asia/Novosibirsk)
- Если lock_id не задан — определяется автоматически при старте
- Все события логируются (ротация 14 дней)
- Важные события отправляются в Telegram
- Все параметры берутся из .env

## Telegram-бот
- Получение важных событий от auto_unlocker в Telegram
- Смена получателя уведомлений (chat_id) через команду `/setchat` и кодовое слово
- Перезапуск auto_unlocker при смене chat_id (если контейнер доступен)
- Логирование событий бота (`logs/telegram_bot.log`)

### Смена получателя уведомлений
1. В Telegram напишите боту команду `/setchat`
2. Введите кодовое слово (по умолчанию `secretword`, можно изменить в .env)
3. Подтвердите смену (ответьте "да")
4. Бот обновит .env и (если возможно) перезапустит auto_unlocker
5. Если контейнер не найден (например, при первом запуске локально), просто перезапустите auto_unlocker вручную после обновления .env

## Docker Compose

В проекте используется `docker-compose.yml`, который поднимает два контейнера:
- `auto_unlocker` — основной сервис
- `telegram_bot` — бот для управления рассылкой и смены chat_id

Оба контейнера используют общий volume `shared_data` для логов:
- `/app/logs` — логи обоих сервисов

.env пробрасывается в оба контейнера через bind-mount:
- `./env/.env:/app/.env`

## Безопасность
- Не публикуйте .env и логи с чувствительными данными
- Используйте сложное кодовое слово
- Для production ограничьте доступ к volume и Telegram-боту

## Справка: unlocker.py (ручные эксперименты)

Файл `unlocker.py` предназначен только для ручных тестов и отладки API TTLock. Не используется в автоматизации и Docker.
- Позволяет вручную получать токен, список замков, открывать/закрывать замок, получать статус
- Все параметры также берёт из .env
- Для автоматизации используйте только `auto_unlocker.py`

---

**Вопросы и доработки:**
Пишите, если нужно добавить поддержку выбора замка по имени, работу с несколькими замками или другие функции! 